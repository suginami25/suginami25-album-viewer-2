#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
--------------------------------------------------------------------
 Suginami25 同期会 アルバムビューア / 自動生成スクリプト
 Project Owner : Yoichi Amano (天野洋一)
 Maintainer    : ChatGPT (Assistant)

 File          : generate_photos_index.py
 Version       : 1.1.0
 Working Dir   : /Users/yoichiamano/Library/CloudStorage/
                 OneDrive-個人用/同期会_写真アーカイブ/
                 CopyData_for _Album_Viewer_for_GitHub/
                 suginami25-album-viewer

 Purpose:
   - photo_data 以下のフォルダ構造から photos_index.js を自動生成する
   - サブフォルダ単位で group を作成
   - 直下に写真ファイルがあるフォルダは、そのフォルダ自体を
     1つの group として扱う（3次会・4次会対応）

 Notes:
   - UTF-8 で保存
   - 日本語フォルダ名・ファイル名を前提
   - OneDrive / GitHub Pages 双方で動作する想定
--------------------------------------------------------------------
"""

import os
import json
from datetime import datetime

PHOTO_ROOT = "photo_data"
OUTPUT_FILE = "photos_index.js"

IMAGE_EXTS = (".jpg", ".jpeg", ".JPG", ".JPEG", ".png", ".PNG")


def is_photo(filename: str) -> bool:
    return filename.endswith(IMAGE_EXTS)


def build_photos_index():
    categories = {}

    # photo_data 直下のフォルダ = category
    for category_name in sorted(os.listdir(PHOTO_ROOT)):
        category_path = os.path.join(PHOTO_ROOT, category_name)
        if not os.path.isdir(category_path):
            continue

        groups = []

        # 1) サブフォルダごとに group を作る
        subdirs = [
            d for d in sorted(os.listdir(category_path))
            if os.path.isdir(os.path.join(category_path, d))
        ]

        for group_dir in subdirs:
            group_path = os.path.join(category_path, group_dir)
            photo_files = [
                f for f in sorted(os.listdir(group_path))
                if os.path.isfile(os.path.join(group_path, f)) and is_photo(f)
            ]
            if not photo_files:
                continue

            photos = []
            for fname in photo_files:
                rel_path = os.path.join(
                    "..", PHOTO_ROOT, category_name, group_dir, fname
                ).replace("\\", "/")
                photos.append({
                    "path": rel_path,
                    "filename": fname,
                })

            groups.append({
                "name": group_dir,
                "photos": photos,
            })

        # 2) category 直下に「野良で」写真がある場合は、
        #    そのフォルダ自体を 1 つの group として扱う
        loose_photos = [
            f for f in sorted(os.listdir(category_path))
            if os.path.isfile(os.path.join(category_path, f)) and is_photo(f)
        ]

        if loose_photos:
            photos = []
            for fname in loose_photos:
                rel_path = os.path.join(
                    "..", PHOTO_ROOT, category_name, fname
                ).replace("\\", "/")
                photos.append({
                    "path": rel_path,
                    "filename": fname,
                })

            groups.append({
                "name": category_name,  # 例: "3次会", "4次会"
                "photos": photos,
            })

        categories[category_name] = {
            "groups": groups
        }

    return {"categories": categories}


def write_js_file(data):
    # JS ファイル冒頭に自動生成コメントを入れる
    ts = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    header = (
        "// ------------------------------------------------------------\n"
        "// Auto-generated file: photos_index.js\n"
        "// Generated by: generate_photos_index.py\n"
        f"// Generated on: {ts}\n"
        "// NOTE: このファイルは自動生成されています。手動編集は推奨されません。\n"
        "// ------------------------------------------------------------\n\n"
    )

    js_body = "const PHOTOS_INDEX = " + json.dumps(
        data, ensure_ascii=False, indent=2
    ) + ";\n\nwindow.PHOTOS_INDEX = PHOTOS_INDEX;\n"

    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        f.write(header)
        f.write(js_body)

    print(f"Wrote {os.path.abspath(OUTPUT_FILE)}")


def main():
    photos_index = build_photos_index()
    write_js_file(photos_index)


if __name__ == "__main__":
    main()